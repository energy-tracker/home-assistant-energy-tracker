name: Sync to Home Assistant Core Fork

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  sync:
    name: Sync to Core Fork
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract tag name
        id: tag
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Checkout core fork
        uses: actions/checkout@v4
        with:
          repository: energy-tracker/core
          token: ${{ secrets.CORE_SYNC_TOKEN }}
          path: core-fork
          fetch-depth: 0

      - name: Configure git
        working-directory: core-fork
        env:
          GIT_AUTHOR_NAME: ${{ secrets.GIT_AUTHOR_NAME }}
          GIT_AUTHOR_EMAIL: ${{ secrets.GIT_AUTHOR_EMAIL }}
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"

      - name: Create or update branch from dev
        working-directory: core-fork
        run: |
          git fetch origin dev
          # Check if branch exists remotely
          if git ls-remote --heads origin energy-tracker-${{ steps.tag.outputs.TAG_NAME }} | grep -q energy-tracker-${{ steps.tag.outputs.TAG_NAME }}; then
            echo "Branch exists, will update it"
            git checkout -B energy-tracker-${{ steps.tag.outputs.TAG_NAME }} origin/dev
          else
            echo "Creating new branch"
            git checkout -b energy-tracker-${{ steps.tag.outputs.TAG_NAME }} origin/dev
          fi

      - name: Sync component files
        run: |
          # Remove old component files
          rm -rf core-fork/homeassistant/components/energy_tracker
          
          # Copy component files
          mkdir -p core-fork/homeassistant/components/energy_tracker
          cp -r custom_components/energy_tracker/* core-fork/homeassistant/components/energy_tracker/
          # Copy translations files
          mkdir -p core-fork/homeassistant/components/energy_tracker/translations
          cp -r custom_components/energy_tracker/translations/* core-fork/homeassistant/components/energy_tracker/translations/

      - name: Sync test files
        run: |
          # Remove old test files
          rm -rf core-fork/tests/components/energy_tracker
          
          # Copy test files
          mkdir -p core-fork/tests/components/energy_tracker
          cp -r tests/* core-fork/tests/components/energy_tracker/

      - name: Rewrite imports for Core
        run: |
          # Rewrite imports from custom_components to homeassistant.components
          find core-fork/homeassistant/components/energy_tracker -type f -name "*.py" -print0 | xargs -0 sed -i 's/from custom_components\.energy_tracker/from homeassistant.components.energy_tracker/g'
          find core-fork/homeassistant/components/energy_tracker -type f -name "*.py" -print0 | xargs -0 sed -i 's/import custom_components\.energy_tracker/import homeassistant.components.energy_tracker/g'
          find core-fork/tests/components/energy_tracker -type f -name "*.py" -print0 | xargs -0 sed -i 's/from custom_components\.energy_tracker/from homeassistant.components.energy_tracker/g'
          find core-fork/tests/components/energy_tracker -type f -name "*.py" -print0 | xargs -0 sed -i 's/import custom_components\.energy_tracker/import homeassistant.components.energy_tracker/g'

          # Rewrite test imports from pytest_homeassistant_custom_component to homeassistant
          find core-fork/tests/components/energy_tracker -type f -name "*.py" -print0 | xargs -0 sed -i 's/from pytest_homeassistant_custom_component\.common import MockConfigEntry/from homeassistant.config_entries import MockConfigEntry/g'
          find core-fork/tests/components/energy_tracker -type f -name "*.py" -print0 | xargs -0 sed -i 's/from pytest_homeassistant_custom_component\.common/from tests.common/g'

          # Remove pytest_homeassistant_custom_component plugin line from conftest.py (not needed in core)
          find core-fork/tests/components/energy_tracker -type f -name "conftest.py" -print0 | xargs -0 sed -i '/pytest_plugins = "pytest_homeassistant_custom_component"/d'

          # Remove auto_enable_custom_integrations fixture from conftest.py (not needed in core)
          find core-fork/tests/components/energy_tracker -type f -name "conftest.py" -print0 | xargs -0 sed -i '/@pytest.fixture(autouse=True)/,/yield/d'

      - name: Verify translations copied
        run: |
          echo "Checking if translations directory exists:"
          ls -la core-fork/homeassistant/components/energy_tracker/
          echo "Translations content:"
          ls -la core-fork/homeassistant/components/energy_tracker/translations/ || echo "Translations directory not found!"

      - name: Create commit
        working-directory: core-fork
        run: |
          git add -A
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "Add Energy Tracker integration ${{ steps.tag.outputs.TAG_NAME }}"

      - name: Push branch
        working-directory: core-fork
        run: |
          # Force push to update existing branch (if PR exists) or push new branch
          git push --force origin energy-tracker-${{ steps.tag.outputs.TAG_NAME }}
          echo "âœ… Branch energy-tracker-${{ steps.tag.outputs.TAG_NAME }} pushed to energy-tracker/core"
          echo "Existing PR will be automatically updated with new commits"
